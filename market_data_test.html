<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveTrader.ai - Market Data Test</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1e3a8a 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 2rem;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(220, 38, 38, 0.3);
        }

        .test-section h2 {
            color: #dc2626;
            margin-bottom: 1rem;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .test-card {
            background: rgba(30, 58, 138, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .test-card h3 {
            margin-top: 0;
            color: #ffffff;
        }

        .test-button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background-color: #10b981;
        }

        .status-disconnected {
            background-color: #ef4444;
        }

        .status-demo {
            background-color: #f59e0b;
        }

        .api-status {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .symbol-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 0.5rem;
            color: white;
            margin-right: 0.5rem;
            width: 100px;
        }

        .symbol-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .loading {
            opacity: 0.6;
        }

        .error {
            color: #ef4444;
        }

        .success {
            color: #10b981;
        }

        .warning {
            color: #f59e0b;
        }

        .ticker-test {
            height: 80px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ LiveTrader.ai Market Data Integration Test</h1>

        <!-- API Status Section -->
        <div class="test-section">
            <h2>üì° API Connection Status</h2>
            <div id="api-status-container">
                <!-- API status will be populated here -->
            </div>
        </div>

        <!-- Real-time Quotes Test -->
        <div class="test-section">
            <h2>üìà Real-time Quotes Test</h2>
            <div class="test-card">
                <h3>Get Stock Quote</h3>
                <div>
                    <input type="text" class="symbol-input" id="quote-symbol" placeholder="AAPL" value="AAPL">
                    <button class="test-button" onclick="testRealTimeQuote()">Get Quote</button>
                    <button class="test-button" onclick="testMultipleQuotes()">Test Multiple</button>
                </div>
                <div class="result-area" id="quote-results">
                    Click "Get Quote" to test real-time data...
                </div>
            </div>
        </div>

        <!-- Historical Data Test -->
        <div class="test-section">
            <h2>üìä Historical Data Test</h2>
            <div class="test-card">
                <h3>Get Historical Data</h3>
                <div>
                    <input type="text" class="symbol-input" id="historical-symbol" placeholder="AAPL" value="AAPL">
                    <button class="test-button" onclick="testHistoricalData()">Get Historical</button>
                    <button class="test-button" onclick="testTechnicalIndicators()">Get Indicators</button>
                </div>
                <div class="result-area" id="historical-results">
                    Click "Get Historical" to test historical data...
                </div>
            </div>
        </div>

        <!-- Market Ticker Test -->
        <div class="test-section">
            <h2>üéØ Enhanced Market Ticker Test</h2>
            <div class="test-card">
                <h3>Live Market Ticker</h3>
                <div>
                    <button class="test-button" onclick="initializeTicker()">Start Ticker</button>
                    <button class="test-button" onclick="destroyTicker()">Stop Ticker</button>
                    <button class="test-button" onclick="testTickerUpdate()">Force Update</button>
                </div>
                <div class="ticker-test" id="ticker-container">
                    <!-- Ticker will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Market Status Test -->
        <div class="test-section">
            <h2>üïê Market Status Test</h2>
            <div class="test-card">
                <h3>Market Hours & Status</h3>
                <div>
                    <button class="test-button" onclick="testMarketStatus()">Check Status</button>
                    <button class="test-button" onclick="testMarketHours()">Check Hours</button>
                </div>
                <div class="result-area" id="market-status-results">
                    Click "Check Status" to test market status...
                </div>
            </div>
        </div>

        <!-- Performance Test -->
        <div class="test-section">
            <h2>‚ö° Performance Test</h2>
            <div class="test-card">
                <h3>API Performance & Rate Limiting</h3>
                <div>
                    <button class="test-button" onclick="testAPIPerformance()">Performance Test</button>
                    <button class="test-button" onclick="testRateLimiting()">Rate Limit Test</button>
                    <button class="test-button" onclick="testCaching()">Cache Test</button>
                </div>
                <div class="result-area" id="performance-results">
                    Click "Performance Test" to test API speed...
                </div>
            </div>
        </div>
    </div>

    <!-- Include market data scripts -->
    <script src="api_config.js"></script>
    <script src="market_data_integration.js"></script>
    <script src="enhanced_market_ticker.js"></script>

    <script>
        // Test functions
        let testTicker = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateAPIStatus();
            logToResults('System initialized. Ready for testing!', 'quote-results', 'success');
        });

        // Update API status display
        function updateAPIStatus() {
            const container = document.getElementById('api-status-container');
            const config = window.API_CONFIG;
            
            let statusHTML = '';
            
            for (const [provider, settings] of Object.entries(config)) {
                const isDemo = settings.key === 'demo';
                const statusClass = isDemo ? 'status-demo' : 'status-connected';
                const statusText = isDemo ? 'Demo Mode' : 'Connected';
                
                statusHTML += `
                    <div class="api-status">
                        <span class="status-indicator ${statusClass}"></span>
                        <strong>${provider.replace('_', ' ')}</strong>: ${statusText}
                        ${isDemo ? '(Configure API key for real data)' : ''}
                    </div>
                `;
            }
            
            container.innerHTML = statusHTML;
        }

        // Test real-time quote
        async function testRealTimeQuote() {
            const symbol = document.getElementById('quote-symbol').value.toUpperCase() || 'AAPL';
            const button = event.target;
            
            button.disabled = true;
            button.textContent = 'Loading...';
            
            logToResults(`Fetching quote for ${symbol}...`, 'quote-results');
            
            try {
                const startTime = Date.now();
                const quote = await window.marketDataManager.getRealTimeQuote(symbol);
                const endTime = Date.now();
                
                const result = {
                    symbol: quote.symbol,
                    price: quote.price,
                    change: quote.change,
                    changePercent: quote.changePercent,
                    volume: quote.volume,
                    source: quote.source,
                    responseTime: `${endTime - startTime}ms`
                };
                
                logToResults(`‚úÖ Quote received:\n${JSON.stringify(result, null, 2)}`, 'quote-results', 'success');
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'quote-results', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Get Quote';
            }
        }

        // Test multiple quotes
        async function testMultipleQuotes() {
            const symbols = ['AAPL', 'GOOGL', 'MSFT', 'TSLA'];
            const button = event.target;
            
            button.disabled = true;
            button.textContent = 'Loading...';
            
            logToResults('Fetching multiple quotes...', 'quote-results');
            
            try {
                const startTime = Date.now();
                const promises = symbols.map(symbol => window.marketDataManager.getRealTimeQuote(symbol));
                const quotes = await Promise.all(promises);
                const endTime = Date.now();
                
                const results = quotes.map(quote => ({
                    symbol: quote.symbol,
                    price: quote.price,
                    change: quote.changePercent.toFixed(2) + '%',
                    source: quote.source
                }));
                
                logToResults(`‚úÖ Multiple quotes received (${endTime - startTime}ms):\n${JSON.stringify(results, null, 2)}`, 'quote-results', 'success');
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'quote-results', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Test Multiple';
            }
        }

        // Test historical data
        async function testHistoricalData() {
            const symbol = document.getElementById('historical-symbol').value.toUpperCase() || 'AAPL';
            const button = event.target;
            
            button.disabled = true;
            button.textContent = 'Loading...';
            
            logToResults(`Fetching historical data for ${symbol}...`, 'historical-results');
            
            try {
                const startTime = Date.now();
                const data = await window.marketDataManager.getHistoricalData(symbol);
                const endTime = Date.now();
                
                if (data && data.length > 0) {
                    const sample = data.slice(0, 3); // Show first 3 data points
                    logToResults(`‚úÖ Historical data received (${data.length} points, ${endTime - startTime}ms):\n${JSON.stringify(sample, null, 2)}\n... and ${data.length - 3} more points`, 'historical-results', 'success');
                } else {
                    logToResults('‚ö†Ô∏è No historical data received', 'historical-results', 'warning');
                }
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'historical-results', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Get Historical';
            }
        }

        // Test technical indicators
        async function testTechnicalIndicators() {
            const symbol = document.getElementById('historical-symbol').value.toUpperCase() || 'AAPL';
            const button = event.target;
            
            button.disabled = true;
            button.textContent = 'Loading...';
            
            logToResults(`Fetching technical indicators for ${symbol}...`, 'historical-results');
            
            try {
                const startTime = Date.now();
                const indicators = await window.marketDataManager.getTechnicalIndicators(symbol, ['RSI', 'MACD']);
                const endTime = Date.now();
                
                if (indicators && Object.keys(indicators).length > 0) {
                    logToResults(`‚úÖ Technical indicators received (${endTime - startTime}ms):\n${JSON.stringify(indicators, null, 2)}`, 'historical-results', 'success');
                } else {
                    logToResults('‚ö†Ô∏è No technical indicators received', 'historical-results', 'warning');
                }
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'historical-results', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Get Indicators';
            }
        }

        // Initialize ticker
        function initializeTicker() {
            if (testTicker) {
                testTicker.destroy();
            }
            
            // Create ticker in test container
            const container = document.getElementById('ticker-container');
            container.innerHTML = '<div id="market-ticker"></div>';
            
            testTicker = new window.EnhancedMarketTicker();
            logToResults('‚úÖ Market ticker initialized', 'market-status-results', 'success');
        }

        // Destroy ticker
        function destroyTicker() {
            if (testTicker) {
                testTicker.destroy();
                testTicker = null;
                document.getElementById('ticker-container').innerHTML = 'Ticker stopped.';
                logToResults('üõë Market ticker stopped', 'market-status-results', 'warning');
            }
        }

        // Test ticker update
        function testTickerUpdate() {
            if (testTicker) {
                testTicker.updateAllData();
                logToResults('üîÑ Ticker update forced', 'market-status-results', 'success');
            } else {
                logToResults('‚ùå No ticker running. Start ticker first.', 'market-status-results', 'error');
            }
        }

        // Test market status
        function testMarketStatus() {
            try {
                const isOpen = window.marketDataManager.isMarketOpen();
                const now = new Date();
                const nyTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
                
                const result = {
                    marketOpen: isOpen,
                    currentTime: now.toISOString(),
                    nyTime: nyTime.toISOString(),
                    day: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][now.getDay()]
                };
                
                logToResults(`Market Status:\n${JSON.stringify(result, null, 2)}`, 'market-status-results', isOpen ? 'success' : 'warning');
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'market-status-results', 'error');
            }
        }

        // Test market hours
        function testMarketHours() {
            try {
                const hours = window.MARKET_HOURS.NYSE;
                const result = {
                    timezone: hours.timezone,
                    regularHours: hours.regular,
                    extendedHours: hours.extended,
                    tradingDays: hours.weekdays
                };
                
                logToResults(`Market Hours Configuration:\n${JSON.stringify(result, null, 2)}`, 'market-status-results', 'success');
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'market-status-results', 'error');
            }
        }

        // Test API performance
        async function testAPIPerformance() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing...';
            
            logToResults('Starting performance test...', 'performance-results');
            
            try {
                const symbols = ['AAPL', 'GOOGL', 'MSFT'];
                const results = [];
                
                for (const symbol of symbols) {
                    const startTime = Date.now();
                    await window.marketDataManager.getRealTimeQuote(symbol);
                    const endTime = Date.now();
                    
                    results.push({
                        symbol: symbol,
                        responseTime: `${endTime - startTime}ms`
                    });
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const avgTime = results.reduce((sum, r) => sum + parseInt(r.responseTime), 0) / results.length;
                
                logToResults(`‚úÖ Performance Test Results:\n${JSON.stringify(results, null, 2)}\n\nAverage Response Time: ${avgTime.toFixed(0)}ms`, 'performance-results', 'success');
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'performance-results', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Performance Test';
            }
        }

        // Test rate limiting
        async function testRateLimiting() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing...';
            
            logToResults('Testing rate limiting (5 rapid requests)...', 'performance-results');
            
            try {
                const promises = [];
                const startTime = Date.now();
                
                // Make 5 rapid requests
                for (let i = 0; i < 5; i++) {
                    promises.push(window.marketDataManager.getRealTimeQuote('AAPL'));
                }
                
                const results = await Promise.all(promises);
                const endTime = Date.now();
                
                logToResults(`‚úÖ Rate Limiting Test:\n- Made 5 rapid requests\n- Total time: ${endTime - startTime}ms\n- All requests successful: ${results.length === 5}\n- Rate limiting working: ${endTime - startTime > 1000 ? 'Yes' : 'No'}`, 'performance-results', 'success');
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'performance-results', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Rate Limit Test';
            }
        }

        // Test caching
        async function testCaching() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing...';
            
            logToResults('Testing cache functionality...', 'performance-results');
            
            try {
                // First request (should hit API)
                const startTime1 = Date.now();
                await window.marketDataManager.getRealTimeQuote('AAPL');
                const endTime1 = Date.now();
                
                // Second request (should hit cache)
                const startTime2 = Date.now();
                await window.marketDataManager.getRealTimeQuote('AAPL');
                const endTime2 = Date.now();
                
                const firstRequestTime = endTime1 - startTime1;
                const secondRequestTime = endTime2 - startTime2;
                
                logToResults(`‚úÖ Cache Test Results:\n- First request: ${firstRequestTime}ms (API call)\n- Second request: ${secondRequestTime}ms (cached)\n- Cache working: ${secondRequestTime < firstRequestTime ? 'Yes' : 'No'}\n- Speed improvement: ${((firstRequestTime - secondRequestTime) / firstRequestTime * 100).toFixed(1)}%`, 'performance-results', 'success');
            } catch (error) {
                logToResults(`‚ùå Error: ${error.message}`, 'performance-results', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Cache Test';
            }
        }

        // Helper function to log results
        function logToResults(message, containerId, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            
            container.innerHTML = `<div class="${className}">[${timestamp}] ${message}</div>` + container.innerHTML;
        }

        // Listen for market data updates
        window.addEventListener('marketDataUpdate', (event) => {
            const { symbol, quote } = event.detail;
            logToResults(`üì° Real-time update: ${symbol} = $${quote.price.toFixed(2)} (${quote.changePercent.toFixed(2)}%)`, 'quote-results', 'success');
        });
    </script>
</body>
</html>